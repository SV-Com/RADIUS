<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios FTTH - FreeRADIUS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .search-box {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            width: 300px;
            transition: border 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead {
            background: #f8f9fa;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tbody tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 30px;
        }

        .modal-header h2 {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            table {
                font-size: 14px;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2>üîê Acceso al Sistema</h2>
        <div id="loginAlert"></div>
        <form id="loginForm">
            <div class="form-group">
                <label>API Key:</label>
                <input type="password" id="apiKeyInput" required placeholder="Ingresa tu API Key">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
        </form>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üåê Gesti√≥n de Usuarios FTTH</h1>
                <p>Sistema de administraci√≥n FreeRADIUS para red PPPoE</p>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="totalUsers">0</div>
                    <div class="label">Total Usuarios</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="activeSessions">0</div>
                    <div class="label">Sesiones Activas</div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="actions-bar">
                    <button class="btn btn-primary" onclick="openCreateUserModal()">
                        ‚ûï Crear Usuario
                    </button>
                    <input type="text" class="search-box" id="searchInput" placeholder="üîç Buscar usuario...">
                    <button class="btn btn-danger" onclick="logout()">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>

                <div id="alertContainer"></div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Contrase√±a</th>
                                <th>Atributos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="4" class="loading">
                                    <div class="spinner"></div>
                                    Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Crear Usuario</h2>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label>Usuario (PPPoE):</label>
                    <input type="text" id="username" required placeholder="usuario@dominio">
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="text" id="password" required placeholder="Contrase√±a">
                </div>
                <div class="form-group">
                    <label>Velocidad Upload:</label>
                    <input type="text" id="bandwidthUp" value="10M" placeholder="10M, 20M, 50M, 100M">
                    <small style="color: #666; display: block; margin-top: 5px;">Formato: Kbps (ej: 10240) o Mbps (ej: 10M)</small>
                </div>
                <div class="form-group">
                    <label>Velocidad Download:</label>
                    <input type="text" id="bandwidthDown" value="10M" placeholder="10M, 20M, 50M, 100M">
                    <small style="color: #666; display: block; margin-top: 5px;">Formato: Kbps (ej: 10240) o Mbps (ej: 10M)</small>
                </div>
                <div class="form-group">
                    <label>Perfil (opcional):</label>
                    <input type="text" id="profile" placeholder="default, premium, etc.">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuraci√≥n - CAMBIAR ESTA URL POR LA DE TU SERVIDOR
        const API_URL = 'http://TU_SERVIDOR/radius-api.php';
        let apiToken = localStorage.getItem('radiusApiToken');

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const apiKey = document.getElementById('apiKeyInput').value;
            
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    apiToken = data.data.token;
                    localStorage.setItem('radiusApiToken', apiToken);
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    loadUsers();
                    loadStats();
                } else {
                    showLoginAlert('API Key incorrecta', 'error');
                }
            } catch (error) {
                showLoginAlert('Error al conectar con el servidor', 'error');
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('radiusApiToken');
            apiToken = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Verificar si ya est√° logueado
        if (apiToken) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadUsers();
            loadStats();
        }

        // Alert functions
        function showLoginAlert(message, type) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertContainer');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`, {
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.data.total_users;
                    document.getElementById('activeSessions').textContent = data.data.active_sessions;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load users
        async function loadUsers(search = '') {
            try {
                const url = new URL(`${API_URL}/users`);
                if (search) url.searchParams.append('search', search);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayUsers(data.data.users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr><td colspan="4" style="text-align: center; color: #e74c3c;">
                        Error al cargar usuarios. Verifica la conexi√≥n con el servidor.
                    </td></tr>
                `;
            }
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay usuarios</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                    <td><small>${user.attributes || 'Sin atributos'}</small></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editUser('${user.username}')">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Search functionality
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadUsers(e.target.value);
            }, 500);
        });

        // Modal functions
        function openCreateUserModal() {
            document.getElementById('modalTitle').textContent = 'Crear Usuario';
            document.getElementById('userForm').reset();
            document.getElementById('username').disabled = false;
            document.getElementById('userModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        // Create user
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                bandwidth_up: document.getElementById('bandwidthUp').value,
                bandwidth_down: document.getElementById('bandwidthDown').value,
                profile: document.getElementById('profile').value
            };
            
            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiToken}`
                    },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Usuario creado exitosamente', 'success');
                    closeModal();
                    loadUsers();
                    loadStats();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Error al crear usuario', 'error');
            }
        });

        // Delete user
        async function deleteUser(username) {
            if (!confirm(`¬øEst√°s seguro de eliminar el usuario ${username}?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/user?username=${username}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Usuario eliminado exitosamente', 'success');
                    loadUsers();
                    loadStats();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Error al eliminar usuario', 'error');
            }
        }

        // Edit user (simplified - opens modal with user data)
        async function editUser(username) {
            // For a complete implementation, you would load user data here
            alert('Funcionalidad de edici√≥n: Implementar carga de datos del usuario y actualizaci√≥n via PUT');
        }
    </script>
</body>
</html>
